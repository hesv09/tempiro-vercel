<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempiro - Analys</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0f1117; --card: #1a1d27; --border: #2a2d3a;
            --text: #e4e4e7; --muted: #8b8d97; --accent: #3b82f6;
            --green: #22c55e; --red: #ef4444; --amber: #f59e0b;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
               background: var(--bg); color: var(--text); min-height: 100vh; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center;
                  margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border);
                  flex-wrap: wrap; gap: 12px; }
        .header h1 { font-size: 1.4rem; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        a.back { color: var(--accent); text-decoration: none; font-size: 0.9rem; }
        a.back:hover { text-decoration: underline; }

        .period-btns { display: flex; gap: 6px; }
        .period-btn { padding: 6px 14px; border: 1px solid var(--border); border-radius: 6px;
                      background: transparent; color: var(--muted); font-size: 0.8rem;
                      cursor: pointer; transition: all 0.2s; }
        .period-btn:hover { border-color: var(--accent); color: var(--accent); }
        .period-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                        gap: 16px; margin-bottom: 24px; }
        .summary-card { background: var(--card); border: 1px solid var(--border);
                        border-radius: 12px; padding: 20px; text-align: center; }
        .summary-value { font-size: 1.8rem; font-weight: 700; }
        .summary-label { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }

        .card { background: var(--card); border: 1px solid var(--border);
                border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .card h2 { font-size: 0.95rem; font-weight: 500; color: var(--muted); margin-bottom: 16px; }
        .chart-container { position: relative; height: 280px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 8px 12px; color: var(--muted);
             font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;
             border-bottom: 1px solid var(--border); }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }
        .num { text-align: right; font-variant-numeric: tabular-nums; }
        .cost-cell { color: var(--amber); font-weight: 600; }
        .kwh-cell { color: var(--accent); }

        .device-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                       gap: 12px; margin-bottom: 24px; }
        .device-stat { background: var(--card); border: 1px solid var(--border);
                       border-radius: 10px; padding: 16px; }
        .device-stat h3 { font-size: 0.9rem; color: var(--muted); margin-bottom: 12px; }
        .device-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .device-label { font-size: 0.8rem; color: var(--muted); }
        .device-value { font-size: 0.8rem; font-weight: 600; }

        @media (max-width: 600px) { body { padding: 12px; } }
    </style>
</head>
<body>
<div class="header">
    <h1>⚡ Tempiro - Analys</h1>
    <div class="header-right">
        <div class="period-btns">
            <button class="period-btn" onclick="setPeriod(7, this)">7 dagar</button>
            <button class="period-btn active" onclick="setPeriod(30, this)">30 dagar</button>
            <button class="period-btn" onclick="setPeriod(90, this)">90 dagar</button>
        </div>
        <a class="back" href="/">← Dashboard</a>
        <a class="back" href="/monthly.html" style="margin-left: 8px;">Månadsöversikt →</a>
    </div>
</div>

<!-- Summering -->
<div class="summary-grid">
    <div class="summary-card">
        <div class="summary-value" style="color: var(--accent)" id="sumKwh">--</div>
        <div class="summary-label">Total energi (kWh)</div>
    </div>
    <div class="summary-card">
        <div class="summary-value" style="color: var(--amber)" id="sumCost">--</div>
        <div class="summary-label">Total kostnad (kr)</div>
    </div>
    <div class="summary-card">
        <div class="summary-value" style="color: var(--green)" id="avgKwhDay">--</div>
        <div class="summary-label">Snitt kWh/dag</div>
    </div>
    <div class="summary-card">
        <div class="summary-value" style="color: var(--amber)" id="avgCostDay">--</div>
        <div class="summary-label">Snitt kostnad/dag (kr)</div>
    </div>
    <div class="summary-card">
        <div class="summary-value" style="color: var(--muted)" id="avgPrice">--</div>
        <div class="summary-label">Snitt elpris (öre/kWh)</div>
    </div>
</div>

<!-- Statistik per enhet -->
<div class="device-grid" id="deviceStats"></div>

<!-- Graf: Daglig energi -->
<div class="card">
    <h2>Daglig energiförbrukning (kWh)</h2>
    <div class="chart-container"><canvas id="dailyChart"></canvas></div>
</div>

<!-- Graf: Daglig kostnad -->
<div class="card">
    <h2>Daglig kostnad (kr)</h2>
    <div class="chart-container"><canvas id="costChart"></canvas></div>
</div>

<!-- Tabell: Dag för dag -->
<div class="card">
    <h2>Dag för dag</h2>
    <table>
        <thead>
            <tr>
                <th>Datum</th>
                <th class="num">Energi (kWh)</th>
                <th class="num">Kostnad (kr)</th>
                <th class="num">Snittspris (öre/kWh)</th>
                <th class="num">VVB1</th>
                <th class="num">VVB2</th>
                <th class="num">VVB3</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
const COLORS = ['#3b82f6', '#22c55e', '#f59e0b'];
let currentDays = 30;
let dailyChart, costChart;

function setPeriod(days, btn) {
    currentDays = days;
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadData();
}

async function loadData() {
    try {
        const resp = await fetch(`/api/daily?days=${currentDays}`);
        const data = await resp.json();
        if (!Array.isArray(data)) throw new Error(data.error || 'Fel');
        render(data);
    } catch(e) {
        console.error('Fel vid laddning:', e);
    }
}

function render(data) {
    if (!data.length) return;

    // Summering
    const totalKwh = data.reduce((s, d) => s + d.total_kwh, 0);
    const totalCost = data.reduce((s, d) => s + d.total_cost, 0);
    const days = data.length;
    const avgKwh = totalKwh / days;
    const avgCost = totalCost / days;
    const avgPrice = totalKwh > 0 ? (totalCost / totalKwh) * 100 : 0;

    document.getElementById('sumKwh').textContent = totalKwh.toFixed(1);
    document.getElementById('sumCost').textContent = totalCost.toFixed(0);
    document.getElementById('avgKwhDay').textContent = avgKwh.toFixed(2);
    document.getElementById('avgCostDay').textContent = avgCost.toFixed(0);
    document.getElementById('avgPrice').textContent = avgPrice.toFixed(1);

    // Enhetsstatistik
    const deviceNames = [...new Set(data.flatMap(d => Object.keys(d.devices)))].sort();
    document.getElementById('deviceStats').innerHTML = deviceNames.map((name, i) => {
        const devKwh = data.reduce((s, d) => s + (d.devices[name]?.kwh || 0), 0);
        const devCost = data.reduce((s, d) => s + (d.devices[name]?.cost || 0), 0);
        const pct = totalKwh > 0 ? (devKwh / totalKwh * 100).toFixed(0) : 0;
        return `<div class="device-stat">
            <h3 style="color: ${COLORS[i % COLORS.length]}">${name}</h3>
            <div class="device-row">
                <span class="device-label">Total energi</span>
                <span class="device-value" style="color: var(--accent)">${devKwh.toFixed(1)} kWh</span>
            </div>
            <div class="device-row">
                <span class="device-label">Total kostnad</span>
                <span class="device-value" style="color: var(--amber)">${devCost.toFixed(0)} kr</span>
            </div>
            <div class="device-row">
                <span class="device-label">Andel av total</span>
                <span class="device-value">${pct}%</span>
            </div>
            <div class="device-row">
                <span class="device-label">Snitt/dag</span>
                <span class="device-value">${(devKwh/days).toFixed(2)} kWh</span>
            </div>
        </div>`;
    }).join('');

    // Daglig energigraf
    const labels = data.map(d => d.day);
    const ctx1 = document.getElementById('dailyChart').getContext('2d');
    if (dailyChart) dailyChart.destroy();
    dailyChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels,
            datasets: deviceNames.map((name, i) => ({
                label: name,
                data: data.map(d => d.devices[name]?.kwh || 0),
                backgroundColor: COLORS[i % COLORS.length] + '80',
                borderColor: COLORS[i % COLORS.length],
                borderWidth: 1, borderRadius: 3,
            }))
        },
        options: barOptions('kWh', v => v.toFixed(2) + ' kWh', true)
    });

    // Kostnadsgraf
    const ctx2 = document.getElementById('costChart').getContext('2d');
    if (costChart) costChart.destroy();
    costChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels,
            datasets: deviceNames.map((name, i) => ({
                label: name,
                data: data.map(d => d.devices[name]?.cost || 0),
                backgroundColor: COLORS[i % COLORS.length] + '80',
                borderColor: COLORS[i % COLORS.length],
                borderWidth: 1, borderRadius: 3,
            }))
        },
        options: barOptions('kr', v => v.toFixed(2) + ' kr', true)
    });

    // Tabell
    document.getElementById('tableBody').innerHTML = [...data].reverse().map(d => {
        const avgP = d.total_kwh > 0 ? (d.total_cost / d.total_kwh * 100).toFixed(1) : '--';
        return `<tr>
            <td>${d.day}</td>
            <td class="num kwh-cell">${d.total_kwh.toFixed(2)}</td>
            <td class="num cost-cell">${d.total_cost.toFixed(0)}</td>
            <td class="num">${avgP}</td>
            ${['VVB1','VVB2','VVB3'].map(n =>
                `<td class="num">${(d.devices[n]?.kwh || 0).toFixed(2)}</td>`
            ).join('')}
        </tr>`;
    }).join('');
}

function barOptions(unit, tooltipFn, stacked) {
    return {
        responsive: true, maintainAspectRatio: false,
        scales: {
            x: { stacked, grid: {color: '#2a2d3a'}, ticks: {color: '#8b8d97'} },
            y: { stacked, grid: {color: '#2a2d3a'}, ticks: {color: '#8b8d97'}, beginAtZero: true }
        },
        plugins: {
            legend: {labels: {color: '#e4e4e7'}},
            tooltip: {callbacks: {label: ctx => `${ctx.dataset.label}: ${tooltipFn(ctx.parsed.y)}`}}
        }
    };
}

loadData();
</script>
</body>
</html>
